name: Rust

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # FIX: Use the reliable taiki-e action to install just
    - uses: taiki-e/install-action@just

    - name: Install musl-tools
      run: |
        sudo apt-get update
        sudo apt-get install -y musl-tools

    - name: Add musl target
      run: rustup target add x86_64-unknown-linux-musl

    # Configure optimization flags (optional but good for OpenWrt)
    - name: Configure Cargo for size
      run: |
        mkdir -p .cargo
        echo '[profile.release]' >> .cargo/config.toml
        echo 'strip = true' >> .cargo/config.toml
        echo 'opt-level = "z"' >> .cargo/config.toml
        echo 'lto = true' >> .cargo/config.toml
        echo 'codegen-units = 1' >> .cargo/config.toml
        echo 'panic = "abort"' >> .cargo/config.toml

    # Build using 'just'. 
    # Note: We set the target via ENV because passing flags to 'just' 
    # depends on how the justfile is written.
    - name: Build with Just
      env:
        CARGO_BUILD_TARGET: x86_64-unknown-linux-musl
        RUSTFLAGS: "-C target-feature=+crt-static" # Ensure static linking
      run: just all-features --release

    - name: Prepare Artifacts
      run: |
        mkdir -p staging
        # REMEMBER: Change 'my-app' to your actual binary name from Cargo.toml
        cp target/x86_64-unknown-linux-musl/release/my-app staging/
        
        echo "Files ready for upload:"
        ls -lh staging/

    - name: Upload OpenWrt Artifact
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-x86_64-binary
        path: staging/
        if-no-files-found: error
