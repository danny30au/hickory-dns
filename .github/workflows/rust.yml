name: Build hickory-dns for OpenWrt x86_64 (All Features)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-unknown-linux-musl
    
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y musl-tools pkg-config
    
    - name: Build static binary with all features
      env:
        RUSTFLAGS: "-C target-feature=+crt-static -C link-arg=-static"
      run: |
        cargo build --release \
          --target x86_64-unknown-linux-musl \
          --all-features \
          -p hickory-dns
    
    - name: Verify static binary
      run: |
        file target/x86_64-unknown-linux-musl/release/hickory-dns
        ldd target/x86_64-unknown-linux-musl/release/hickory-dns || echo "Static binary confirmed"
        ls -lh target/x86_64-unknown-linux-musl/release/hickory-dns
    
    - name: Strip binary
      run: |
        strip target/x86_64-unknown-linux-musl/release/hickory-dns
        ls -lh target/x86_64-unknown-linux-musl/release/hickory-dns
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: hickory-dns-openwrt-x86_64-full
        path: target/x86_64-unknown-linux-musl/release/hickory-dns
        retention-days: 30
