name: OpenWrt Static Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # 1. Install 'cross' (The robust builder tool)
    - uses: taiki-e/install-action@cross

    # 2. Build Fully Static Binary
    # - target: x86_64-unknown-linux-musl (OpenWrt native)
    # - crt-static: This is the magic flag that removes all external dependencies
    - name: Build Static Binary
      env:
        RUSTFLAGS: "-C target-feature=+crt-static"
      run: cross build --verbose --release --target x86_64-unknown-linux-musl --all-features

    # 3. Strip & Verify
    # This reduces file size and confirms the binary has no dependencies
    - name: Prepare Artifacts
      run: |
        mkdir -p staging
        
        # -----------------------------------------------------------
        # CHECK YOUR BINARY NAME HERE (e.g., hickory-dns, my-app)
        # -----------------------------------------------------------
        BINARY_NAME="hickory-dns"
        SOURCE_PATH="target/x86_64-unknown-linux-musl/release/$BINARY_NAME"
        
        if [ ! -f "$SOURCE_PATH" ]; then
            echo "Error: Binary '$BINARY_NAME' not found at $SOURCE_PATH"
            ls -F target/x86_64-unknown-linux-musl/release/
            exit 1
        fi

        echo "Processing $BINARY_NAME..."
        
        # 1. Check if it is actually static (should say 'statically linked')
        file "$SOURCE_PATH"
        
        # 2. Strip debug symbols (Drastically reduces size for OpenWrt)
        strip "$SOURCE_PATH"
        
        # 3. Copy to staging
        cp "$SOURCE_PATH" staging/
        
        echo "Success! Final binary size:"
        ls -lh staging/

    # 4. Upload
    - name: Upload OpenWrt Artifact
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-static-binary
        path: staging/
        if-no-files-found: error
