name: Rust

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # 1. Install 'just' using a pre-built action (fastest method)
    - uses: extra-toolchains/setup-just@v2

    - name: Install musl-tools
      run: |
        sudo apt-get update
        sudo apt-get install -y musl-tools

    - name: Add musl target
      run: rustup target add x86_64-unknown-linux-musl

    # 2. Run 'just' to build
    # Assuming your justfile handles the build command.
    # If your justfile recipe is named 'all-features', use that.
    # We pass the target flag if your justfile accepts arguments, 
    # OR you might need to set CARGO_BUILD_TARGET env var if the justfile doesn't pass args.
    - name: Build with Just
      env:
        # Many justfiles respect Cargo env vars
        CARGO_BUILD_TARGET: x86_64-unknown-linux-musl
      run: just all-features --release

    - name: Prepare Artifacts
      run: |
        mkdir -p staging
        # Update path if 'just' outputs somewhere else, but usually it's standard cargo target
        # REMEMBER: Check your Cargo.toml for the binary name!
        cp target/x86_64-unknown-linux-musl/release/YOUR_BINARY_NAME staging/
        
        echo "Files ready for upload:"
        ls -lh staging/

    - name: Upload OpenWrt Artifact
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-x86_64-binary
        path: staging/
        if-no-files-found: error
